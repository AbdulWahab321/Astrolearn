{% extends 'base.html' %}

{% block title %}Quiz: {{ chapter }}{% endblock %}

{% block head %}
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
 
{% endblock %}

{% block content %}
<div class="development-box" id="developmentBox" style="align-self: center;top:75%">
    <p>Please note that the Quizzes section is still under development. The questions are placeholders and may not be accurate, and you might encounter unexpected behaviors.
    </p>
</div>
    <div class="quiz-container" id="quiz-container">
        <div class="timer-container">
            <div id="timer" class="timer"></div>
        </div>
        <div id="question-container" class="question-container">
            <h2 id="question" class="question"></h2>
            <div id="options" class="options"></div>
        </div>
        <div class="navigation">
            <button id="prev-btn" class="nav-btn">Previous</button>
            <span id="question-number" class="question-number"></span>
            <button id="next-btn" class="nav-btn">Next</button>
        </div>
    </div>

    <div id="results-container" class="results-container hidden">
        <h2>Quiz Results</h2>
        <p id="score" class="score"></p>
        <div id="detailed-results"></div>
        <button id="retry-btn" class="retry-btn">Retry Quiz</button>
        <div class="p-6">
            <a href="{{ url_for('chapter', subject=subject, chapter=chapter) }}" class="inline-block bg-secondary-light dark:bg-secondary-dark text-white py-2 px-4 rounded hover:bg-opacity-80 transition duration-300">Learn</a>
        </div>        
    </div>

    <script>
        const quizData = {{ quiz_data | tojson | safe }};
        var quiz_data = shuffleArray(quizData);
        const quizTimeLimit = {{ quiz_time_limit | tojson }};
        let currentQuestion = 0;
        let score = 0;
        let userAnswers = [];
        let timer;
        let timeLeft;
        function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]]; // Swap elements
        }
        }
        function initializeQuiz() {
            loadQuestion();
            if (quizTimeLimit !== false) {
                startTimer(quizTimeLimit);
            } else {
                document.getElementById('timer').textContent = 'No time limit';
            }
        }

        function loadQuestion() {
            const question = quizData[currentQuestion];
            document.getElementById('question').innerHTML = question.question;
            const optionsContainer = document.getElementById('options');
            optionsContainer.innerHTML = '';
            
            question.options.forEach((option, index) => {
                const button = document.createElement('button');
                button.innerHTML = option; // Use innerHTML instead of textContent for HTML content
                button.id = "option-" + index;
                button.className = 'option-btn';
                button.onclick = () => selectOption(index);
                optionsContainer.appendChild(button);
            });
            
            document.getElementById('question-number').textContent = `Question ${currentQuestion + 1} of ${quizData.length}`;
            document.getElementById('prev-btn').disabled = currentQuestion === 0;
            document.getElementById('next-btn').textContent = currentQuestion === quizData.length - 1 ? 'Finish' : 'Next';

            if (userAnswers[currentQuestion] !== undefined) {
                selectOption(userAnswers[currentQuestion]);
            }

            // Add animation to question container
            const questionContainer = document.getElementById('question-container');
            questionContainer.style.animation = 'none';
            questionContainer.offsetHeight; // Trigger reflow
            questionContainer.style.animation = null;

            // Process LaTeX with MathJax
            MathJax.typeset();
        }
        function startTimer(duration) {
            timeLeft = duration;
            updateTimerDisplay();
            timer = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();
                if (timeLeft <= 0) {
                    clearInterval(timer);
                    showResults();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            document.getElementById('timer').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        function selectOption(index) {
            const buttons = document.querySelectorAll('.option-btn');
            buttons.forEach((button, i) => {
                if (i === index) {
                    button.classList.add('selected');
                } else {
                    button.classList.remove('selected');
                }
            });
            userAnswers[currentQuestion] = index;
        }

        function showResults() {
            if (timer) clearInterval(timer);
            score = quizData.reduce((acc, question, index) => {
                return acc + (userAnswers[index] === question.correct_answer ? 1 : 0);
            }, 0);
            
            document.getElementById('quiz-container').classList.add('hidden');
            document.getElementById('results-container').classList.remove('hidden');
            document.getElementById('score').textContent = `You scored ${score} out of ${quizData.length}`;
            
            showDetailedResults();
            showConfetti();
        }

        function showDetailedResults() {
            const detailedResults = document.getElementById('detailed-results');
            detailedResults.innerHTML = '';

            quizData.forEach((question, index) => {
                const userAnswer = userAnswers[index];
                let status, statusClass;

                if (userAnswer === undefined) {
                    status = 'Skipped';
                    statusClass = 'skipped';
                } else if (userAnswer === question.correct_answer) {
                    status = 'Correct';
                    statusClass = 'correct';
                } else {
                    status = 'Incorrect';
                    statusClass = 'incorrect';
                }

                const resultCard = document.createElement('div');
                resultCard.className = `result-card ${statusClass}`;

                resultCard.innerHTML = `
                    <div class="result-card-header">
                        Question ${index + 1}
                    </div>
                    <div class="result-card-body">
                        <div class="result-status status-${statusClass.toLowerCase()}">${status}</div>
                        <p class="question-text">${question.question}</p>
                        ${userAnswer !== undefined ? `
                            <p class="answer-text">Your answer: <span class="user-answer ${statusClass === 'correct' ? 'correct-answer' : 'incorrect-answer'}">${question.options[userAnswer]}</span></p>
                        ` : '<p class="answer-text">You skipped this question</p>'}
                        ${statusClass === 'incorrect' ? `
                            <p class="answer-text">Correct answer: <span class="correct-answer">${question.options[question.correct_answer]}</span></p>
                        ` : ''}
                    </div>
                `;

                detailedResults.appendChild(resultCard);
            });

            // Process LaTeX with MathJax for the detailed results
            MathJax.typeset();
        }

        function showConfetti() {
            const confettiCount = 200;
            const colors = ['#fce18a', '#ff726d', '#b48def', '#f4306d'];

            for (let i = 0; i < confettiCount; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.left = Math.random() * 100 + 'vw';
                confetti.style.animationDuration = (Math.random() * 3 + 2) + 's';
                confetti.style.opacity = Math.random();
                document.body.appendChild(confetti);

                setTimeout(() => confetti.remove(), 5000);
            }
        }

        document.getElementById('prev-btn').addEventListener('click', () => {
            if (currentQuestion > 0) {
                currentQuestion--;
                loadQuestion();
            }
        });

        document.getElementById('next-btn').addEventListener('click', () => {
            if (currentQuestion < quizData.length - 1) {
                currentQuestion++;
                loadQuestion();
            } else {
                showResults();
            }
        });

        document.getElementById('retry-btn').addEventListener('click', () => {
            currentQuestion = 0;
            score = 0;
            userAnswers = [];
            document.getElementById('quiz-container').classList.remove('hidden');
            document.getElementById('results-container').classList.add('hidden');
            initializeQuiz();
        });

        initializeQuiz();
    </script>
{% endblock %}
